#!/bin/bash

#=================================================
# GENERIC START
#=================================================

# IMPORT GENERIC HELPERS
source /usr/share/yunohost/helpers

# Exit if an error occurs during the execution of the script
ynh_abort_if_errors

# Load common variables and helpers
source ./_common.sh

# Retrieve arguments
domain=$YNH_APP_ARG_DOMAIN
path_url=$YNH_APP_ARG_PATH
is_public=$YNH_APP_ARG_IS_PUBLIC
admin=$YNH_APP_ARG_ADMIN

# Check domain/path availability
ynh_webpath_available $domain $path_url || ynh_die "$domain is not available as domain, please use an other domain."
ynh_webpath_register $app $domain $path_url

# Check user parameter
ynh_user_exists "$admin" \
  || ynh_die "The chosen admin user does not exist."

mailadmin=$(ynh_user_get_info $admin mail)
port=$(ynh_find_port 8080)
portUnicorn=$(ynh_find_port 9080)
rdmPass=$(ynh_string_random 30)

# Save app settings
ynh_app_setting_set $app admin $admin
ynh_app_setting_set $app path_url $path_url
ynh_app_setting_set $app is_public $is_public
ynh_app_setting_set $app web_port $port
ynh_app_setting_set $app unicorn_port $portUnicorn

#=================================================
# STANDARD MODIFICATIONS
#=================================================

# Modify Nginx configuration file and copy it to Nginx conf directory
config_nginx

create_dir

# Configure gitlab with gitlab.rb file
config_gitlab

# Add dependencies
ynh_install_app_dependencies openssh-server

# Update to the last version
update_src_version

# Install gitlab
setup_source $architecture

echo "newuser = User.new({ \"email\"=>'$mailadmin', \"username\"=>'$admin', \"name\"=>'$admin', \"password\"=>'$rdmPass'})
newuser.admin = true
newuser.confirmed_at = Time.now
newuser.confirmation_token = nil
newuser.save"  | sudo gitlab-rails console

sudo gitlab-ctl reconfigure

# If app is public, add url to SSOWat conf as skipped_uris
if [[ $is_public -eq 1 ]]; then
  # unprotected_uris allows SSO credentials to be passed anyway.
  ynh_app_setting_set "$app" unprotected_uris "/"
fi

# Configure logrotate
#ynh_use_logrotate "/var/log/$app"

# Reload services
#sudo yunohost app ssowatconf
#sudo service nginx reload
#sudo gitlab-ctl restart
